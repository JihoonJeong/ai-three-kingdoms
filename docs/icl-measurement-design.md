# ICL 효력 측정 설계 — Ablation Study

> **목적**: "ICL이 정말 효과가 있는가?"를 정량적으로 입증
> **작성**: Buddy (2026-02-17)
> **기존 데이터**: Gemini 3 Flash Preview, ~100게임 (Gemini Lab)
> **신규 데이터**: 로컬 모델 (qwen3:8b 등), Windows Lab

---

## 1. 문제 정의

### 현재까지의 증거 (Gemini Lab)

| 조건 | 등급 분포 | 적벽 승률 |
|------|-----------|-----------|
| ICL 없음 (대조군) | 3D+2F | 0% |
| Seed ICL + normal | 4C+1F | 100% |
| Seed ICL + 코칭 + normal | 5C | 100% |
| Seed ICL + 코칭 + easy | 2A+1B+1D+1F | 60% |

**문제**: 이 데이터만으로는 아래를 분리할 수 없음:
1. ICL(경험 주입)의 효과 vs MilestoneCoach(적시 코칭)의 효과
2. 커리큘럼(난이도 조정)의 효과 vs ICL의 효과
3. 시드 경험의 효과 vs 순차 축적 경험의 효과

### 이번 실험의 핵심 질문

```
Q1: ICL은 코칭 없이도 효과가 있는가?
Q2: 코칭은 ICL 없이도 효과가 있는가?
Q3: ICL + 코칭에 시너지가 있는가? (1+1 > 2?)
Q4: 위 결과가 다른 모델(로컬 7B)에서도 재현되는가?
```

---

## 2. 실험 설계: 2×2 요인 분석

### 독립변수

| 변수 | 수준 | 조작 방법 |
|------|------|----------|
| **ICL** | ON / OFF | `--seed-library` 사용 여부 + `--no-icl` 플래그 |
| **코칭** | ON / OFF | `--no-coach` 플래그 (Cody 구현 필요) |

### 통제변수 (모든 실험에서 고정)

| 변수 | 값 | 이유 |
|------|-----|------|
| 난이도 | easy | B+ 발생 가능한 난이도여야 효과 측정 가능 |
| 모드 | A (자동수락) | Mode B는 추가 변수 도입 |
| thinking | OFF (--no-think) | 로컬 7B에서 thinking 효과 미미 |
| 시드 라이브러리 | o4-mini-wins.json | 기존 검증된 시드 사용 |
| 게임 수 | 20게임/조건 | 통계적 유의성 확보 (아래 검정력 분석) |

### 종속변수 (측정 지표)

| 지표 | 측정 방법 | 왜 이 지표인가 |
|------|----------|---------------|
| **B+등급 비율** | (A+B+S 수) / 총 게임 수 | 최종 성과 — "B를 달성했는가?" |
| **B근접도 평균** | mean(bProximityScore) | 연속 척도 — B에 얼마나 가까운가 |
| **적벽 승률** | chibiVictory / 총 게임 수 | 중간 성과 — 1차 관문 통과율 |
| **F등급 비율** | F 수 / 총 게임 수 | 안전성 — 치명적 실패 빈도 |
| **수렴 속도** | B+등급 최초 등장 게임 번호 | 학습 효율 — 몇 판 만에 돌파하는가 |
| **학습 곡선 기울기** | B근접도 이동평균의 회귀 기울기 | 학습 추세 — 개선되고 있는가 |

---

## 3. 실험 매트릭스

```
              코칭 ON          코칭 OFF
           ┌─────────────┬─────────────┐
ICL ON     │  A1 (실험군)  │  B1 (ICL만)  │
           │  20게임       │  20게임       │
           ├─────────────┼─────────────┤
ICL OFF    │  A2 (코칭만)  │  B2 (베이스) │
           │  20게임       │  20게임       │
           └─────────────┴─────────────┘
```

### 효과 계산

```
ICL 주효과     = mean(A1, B1) - mean(A2, B2)
코칭 주효과    = mean(A1, A2) - mean(B1, B2)
상호작용 효과  = A1 - A2 - B1 + B2
```

### 가설

| 가설 | 예측 | 근거 |
|------|------|------|
| H1: ICL 주효과 > 0 | B근접도 +10%p 이상 | Gemini에서 ICL OFF=0%, ON=100% 적벽승률 |
| H2: 코칭 주효과 > 0 | F등급 감소, B근접도 +5%p | Gemini에서 코칭 → F 소멸 |
| H3: 상호작용 > 0 | ICL+코칭 시너지 존재 | ICL이 "무엇을"을 가르치고 코칭이 "언제"를 가르침 |
| H0: 모델 전이 | 로컬 7B에서도 방향 동일 | Core가 다르면 크기가 다를 수 있으나 방향은 동일 |

---

## 4. 통계 분석 계획

### 4.1 기초 통계

각 조건별:
- 등급 분포표 (S/A/B/C/D/F 빈도)
- B근접도: 평균, 표준편차, 최소, 최대
- 적벽 승률: 비율 + 95% 신뢰구간

### 4.2 효과 크기

**B근접도 차이** (연속 변수):
```
ICL 효과 = mean(A1+B1) - mean(A2+B2)
코칭 효과 = mean(A1+A2) - mean(B1+B2)
```

**해석 기준**:
- 차이 < 5%p → 실질적 효과 없음
- 차이 5~15%p → 중간 효과
- 차이 > 15%p → 강한 효과

**B+등급 비율 차이** (이산 변수):
```
ICL 효과 = B+rate(A1+B1) - B+rate(A2+B2)
```

### 4.3 통계 검정 (참고용)

20게임/조건이므로 엄밀한 통계 검정은 어렵지만, 효과가 크면 유의미:

- **Fisher's exact test**: B+등급 달성 여부 (2×2 빈도표)
- **Mann-Whitney U**: B근접도 분포 비교 (비모수)
- **학습 곡선**: 게임 번호 vs B근접도 산점도 + 선형 회귀

> n=20에서 유의하려면 효과가 매우 커야 함 (B+비율 0% vs 15%+ 수준).
> 이것이 바로 cost 0인 로컬 모델의 장점 — 필요 시 n=50으로 확장 가능.

### 4.4 검정력 사전 분석

B+등급 비율에 대한 Fisher's exact test (α=0.05, one-sided):

| n/조건 | 최소 검출 가능 차이 | 설명 |
|--------|-------------------|------|
| 20 | 0% vs 25% (5/20) | 한쪽이 5개 이상이면 유의 |
| 50 | 0% vs 14% (7/50) | 확장 시 더 작은 차이 검출 가능 |

Gemini easy에서 B+비율 = 60% (3/5)였으므로, 효과가 진짜라면 n=20에서 충분히 검출 가능.

---

## 5. 학습 곡선 분석

### 수렴 속도 비교

각 조건별 "최초 B+ 달성 게임 번호":
```
A1 (ICL+코칭):  게임 ?번째에 최초 B+
A2 (코칭만):     게임 ?번째에 최초 B+ (또는 미달성)
B1 (ICL만):      게임 ?번째에 최초 B+
B2 (베이스):     (미달성 예상)
```

### 이동평균 학습 곡선

B근접도의 5게임 이동평균을 그래프로:
```
게임 번호 (x축) vs B근접도 5MA (y축)

예상 패턴:
  A1: ___/‾‾‾ (초반 낮다가 빠르게 상승)
  A2: ___/── (느리게 상승, 낮은 천장)
  B1: __/── (중간 속도, 중간 천장)
  B2: ───── (평탄, 낮은 수준 유지)
```

### 누적 B+ 비율 곡선

누적 게임 수 대비 B+ 비율 변화:
```
게임 수 (x축) vs 누적 B+% (y축)

핵심 관찰점:
- A1이 가장 빨리 상승하면 → ICL+코칭 시너지 확인
- A2 ≈ B1이면 → ICL과 코칭이 독립적 기여
- A1 >> A2 + B1 - B2이면 → 시너지 존재
```

---

## 6. 예상 결과 시나리오

### 시나리오 1: ICL이 지배적 (ICL >> 코칭)
```
A1: 2A+5B+10C+3D     B+율 35%   B근접도 52%
A2: 15C+5D            B+율 0%    B근접도 30%
B1: 1A+3B+12C+4D     B+율 20%   B근접도 48%
B2: 12C+8D            B+율 0%    B근접도 22%

→ ICL 효과: +27%p B+, +24%p B근접도
→ 코칭 효과: +7.5%p B+, +6%p B근접도
→ 결론: ICL이 핵심, 코칭은 보조
```

### 시나리오 2: 코칭이 지배적 (코칭 >> ICL)
```
A1: 1A+4B+12C+3D     B+율 25%   B근접도 50%
A2: 1A+3B+13C+3D     B+율 20%   B근접도 47%
B1: 15C+5D            B+율 0%    B근접도 28%
B2: 12C+8D            B+율 0%    B근접도 22%

→ ICL 효과: +2.5%p B+, +4.5%p B근접도
→ 코칭 효과: +22.5%p B+, +23.5%p B근접도
→ 결론: 코칭이 핵심, ICL은 보조
```

### 시나리오 3: 시너지 (ICL × 코칭)
```
A1: 3A+5B+10C+2D     B+율 40%   B근접도 55%
A2: 15C+5D            B+율 0%    B근접도 32%
B1: 14C+6D            B+율 0%    B근접도 30%
B2: 12C+8D            B+율 0%    B근접도 22%

→ ICL 주효과: +4%p B근접도 (작음)
→ 코칭 주효과: +5%p B근접도 (작음)
→ 상호작용: +23%p B근접도 (거대!) ← 시너지
→ 결론: ICL도 코칭도 단독으로는 약하지만 결합하면 폭발적
```

### 시나리오 4: 난이도가 지배적 (둘 다 불필요)
```
A1: 2A+4B+11C+3D     B+율 30%   B근접도 48%
A2: 1A+3B+13C+3D     B+율 20%   B근접도 45%
B1: 1A+2B+14C+3D     B+율 15%   B근접도 42%
B2: 1A+2B+14C+3D     B+율 15%   B근접도 40%

→ 모든 차이 < 10%p
→ 결론: easy 난이도 자체가 B를 가능하게 함. ICL/코칭 효과 미미.
→ 함의: Hardware(환경)이 거의 모든 것을 결정
```

**각 시나리오의 함의가 매우 다르다.** 이것이 ablation을 해야 하는 이유.

---

## 7. 결과 해석 프레임워크

### Four-Shell Model 관점

```
결과 → 해석:

ICL 효과 큼     → Soft Shell이 Phenotype을 변화시킨다 (기존 가설 강화)
코칭 효과 큼    → Hard Shell(적시)이 Phenotype을 변화시킨다
시너지 큼       → "무엇을"(Soft) + "언제"(Hard) 결합이 최적
둘 다 작음      → Hardware(환경)가 지배적 → Four-Shell에서 Hardware 층 중요도 상향

추가로:
로컬에서 재현 O → Core 독립적 — 어떤 모델에서든 작동하는 범용 원칙
로컬에서 재현 X → Core 의존적 — Gemini Flash 특화 효과
```

### 보고 템플릿

```markdown
## ICL 효력 측정 결과 (모델: qwen3:8b)

### 2×2 요인 분석 결과

|  | 코칭 ON | 코칭 OFF | 코칭 효과 |
|--|---------|----------|----------|
| **ICL ON** | B+:__%, B근접:__% | B+:__%, B근접:__% | |
| **ICL OFF** | B+:__%, B근접:__% | B+:__%, B근접:__% | |
| **ICL 효과** | | | **상호작용: __** |

### 핵심 결론
- ICL 효과: __ (강/중/약/없음)
- 코칭 효과: __ (강/중/약/없음)
- 시너지: __ (있음/없음)
- 모델 전이: __ (성공/부분/실패)
- 지배적 요인: __ (ICL/코칭/시너지/난이도/Core)
```

---

## 8. 확장 실험 (결과에 따라)

### ICL이 효과적인 경우
- **시드 품질 비교**: o4-mini 시드 vs Gemini A급 시드 vs 랜덤 C급 시드
- **시드 개수 비교**: 1개 vs 3개 vs 8개
- **선택 전략 비교**: balanced vs best vs recent vs diverse

### 코칭이 효과적인 경우
- **코칭 밀도 비교**: 마일스톤 4개 vs 징병 반복 코칭(매 턴) vs 최소 코칭(1개)
- **코칭 내용 비교**: 전략 코칭 vs 금지 코칭 vs 격려 코칭

### 난이도가 지배적인 경우
- **난이도 그래디언트 세분화**: easy(0.7) / 0.68 / 0.65 / 0.62 / 0.60 (5단계)
- **임계점 정밀 탐색**: B+ 발생 최소 난이도 (collapse ratio 기준)

---

## 9. 데이터 보존

### 필수 보존 파일
```
sim/results/batch-*.json              ← 모든 배치 결과
sim/results/experience-*.json         ← 모든 경험 파일
```

### 파일명 기록표

각 실험 완료 시 아래 표에 기록:

| 실험 | batch 파일 | experience 파일 |
|------|-----------|----------------|
| A1 | batch-XXXX.json | experience-XXXX.json |
| A2 | batch-XXXX.json | (no-icl이므로 경험 축적 없음) |
| B1 | batch-XXXX.json | experience-XXXX.json |
| B2 | batch-XXXX.json | (no-icl이므로 경험 축적 없음) |
| C1 | batch-XXXX.json | experience-XXXX.json |
| C2 | batch-XXXX.json | experience-XXXX.json |
| D1 | batch-XXXX.json | — |

> **주의**: `--no-icl` 실행 시에도 `--sequential`이면 experience 파일이 생성될 수 있음 (경험 추출은 하되 주입은 안 함). 파일 존재 여부와 무관하게 실험 조건을 정확히 기록할 것.
